<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English MockTest - Full Exam</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <style>
    body { 
  font-family: "Be Vietnam Pro", sans-serif; 
  background: #f7f8fb; 
  margin: 0; 
  padding: 36px; 
  color: #222 
}
.container { 
  max-width: 980px; 
  margin: 0 auto; 
}
h1 { 
  text-align: center; 
  color: #0b74ff; 
  margin-bottom: 18px 
}
.card { 
  background: #fff; 
  border-radius: 12px; 
  padding: 24px; 
  box-shadow: 0 6px 18px rgba(20,20,40,0.06); 
}
.center { 
  text-align: center 
}
.btn { 
  background: #0b74ff; 
  color: #fff; 
  padding: 10px 16px; 
  border-radius: 8px; 
  border: none; 
  cursor: pointer 
}
.btn:disabled { 
  background: #bfcfe8; 
  cursor: not-allowed 
}
.timer { 
  color: #d9534f; 
  font-weight: 700; 
  margin-bottom: 12px; 
  text-align: center 
}
.choices button { 
  display: block; 
  width: 100%; 
  padding: 10px; 
  margin: 8px 0; 
  border-radius: 8px; 
  border: 1px solid #e3e6ea; 
  background: #f5f6f8; 
  cursor: pointer; 
  text-align: left 
}
.choices button.selected { 
  background: #0b74ff; 
  color: #fff 
}
.passage { 
  background: #f3f6ff; 
  padding: 14px; 
  border-radius: 8px; 
  margin-bottom: 12px; 
  white-space: pre-line 
}
.nav { 
  display: flex; 
  justify-content: space-between; 
  margin-top: 18px 
}
textarea { 
  width: 100%; 
  min-height: 180px; 
  padding: 10px; 
  border-radius: 8px; 
  border: 1px solid #e3e6ea 
}
.muted { 
  color: #666; 
  font-size: 0.95rem 
}
  </style>
  
</head>
<body>
  <div class="container">
    <h1>üß† English MockTest - Full Exam</h1>
    <div id="root"></div>
  </div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const _mockData = {
      times: { reading: 15*60, writing: 20*60, listening: 10*60 },
      reading: {
        passageTitle: "Where are the Harry Potter Stars now?",
        passageText: "The actors who played the children in the Harry Potter movies are now adults...",
        questions: [
          // Th√™m 'id' ƒë·ªÉ d·ªÖ qu·∫£n l√Ω
          { id: "r1", q: "1. Who thought about leaving the Harry Potter series?", options:["Daniel Radcliffe","Rupert Grint","Emma Watson"], correct:"Rupert Grint" },
          { id: "r2", q: "2. Who felt similar to their character?", options:["Daniel Radcliffe","Rupert Grint","Emma Watson"], correct:"Emma Watson" }
        ]
      },
      writing: {
        prompt: `"A problem shared is a problem halved". Write an essay about discussing personal problems with a friend.`,
        guidance: "Write about 250‚Äì350 words."
      },
      listening: [
        { id: "l1", q: "1. Wakeboarding began in ________.", correct: "California" },
        { id: "l2", q: "2. The wakeboarder is pulled behind a boat that travels at about ________ mph.", correct: "25" },
        { id: "l3", q: "3. A spin of 1260 degrees means turning around ________ and a half times.", correct: "three" },
        { id: "l4", q: "4. The Wakestock festival takes place in ________, North Wales.", correct: "Abersoch" },
        { id: "l5", q: "5. About ________ million people around the world do wakeboarding.", correct: "3" },
        { id: "l6", q: "6. Roller derby originally began in the ________.", correct: "1930s" },
        { id: "l7", q: "7. Where did the revival of roller derby start?", options: ["A. Canada","B. Texas","C. England","D. Australia"], correct: "B. Texas" },
        { id: "l8", q: "8. How many players are there on each roller derby team?", options: ["A. Four","B. Five","C. Six","D. Seven"], correct: "B. Five" },
        { id: "l9", q: "9. What happens if a player trips another one?", options: ["A. She is penalised.","B. The team loses a point.","C. The game stops.","D. The player is sent off."], correct: "A. She is penalised." },
        { id: "l10", q: "10. What is Jules‚Äô nickname?", options: ["A. The Julexpress","B. The Julifier","C. The Roller Jules","D. The Fast Juls"], correct: "B. The Julifier" }
      ]
    };

    // L·ªõp Repo: Ch·ªâ cung c·∫•p data
    const mockTestRepo = {
      // L·∫•y data cho UI (ƒë√£ lo·∫°i b·ªè ƒë√°p √°n)
      getReadingDataForUI: () => {
        return {
          passageTitle: _mockData.reading.passageTitle,
          passageText: _mockData.reading.passageText,
          questions: _mockData.reading.questions.map(q => ({
            id: q.id,
            q: q.q,
            options: q.options
          }))
        };
      },
      getListeningDataForUI: () => {
         return _mockData.listening.map(q => ({
            id: q.id,
            q: q.q,
            options: q.options
          }));
      },
      
      // L·∫•y data ƒë√°p √°n (ch·ªâ cho Service)
      getReadingAnswers: () => _mockData.reading.questions.map(q => ({ id: q.id, correct: q.correct })),
      getListeningAnswers: () => _mockData.listening.map(q => ({ id: q.id, correct: q.correct })),

      // L·∫•y data kh√°c
      getWritingData: () => _mockData.writing,
      getTimes: () => _mockData.times
    };

    const mockTestService = {
      // Logic ch·∫•m ƒëi·ªÉm Reading
      calculateReadingScore: (userAnswers) => {
        const correctAnswers = mockTestRepo.getReadingAnswers();
        
        let correctCount = 0;
        correctAnswers.forEach(answer => {
          // So s√°nh c√¢u tr·∫£ l·ªùi c·ªßa user (theo id) v·ªõi ƒë√°p √°n ƒë√∫ng
          if (userAnswers[answer.id] === answer.correct) {
            correctCount++;
          }
        });
        
        return { correctCount, total: correctAnswers.length };
      },
      
      // Logic ch·∫•m ƒëi·ªÉm Listening
      calculateListeningScore: (userAnswers) => {
        const correctAnswers = mockTestRepo.getListeningAnswers();

        let correctCount = 0;
        correctAnswers.forEach(answer => {
          const userAnswer = String(userAnswers[answer.id] || "").trim().toLowerCase();
          const correctAnswer = String(answer.correct).toLowerCase();
          if (userAnswer === correctAnswer) {
            correctCount++;
          }
        });

        return { correctCount, total: correctAnswers.length };
      }
    };


    // =================================================================
    // ===== 3. UI LAYER (React Components) ============================
    // =================================================================
    
    const Timer = ({ seconds }) => {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return <div className="timer">Time Remaining: {String(m).padStart(2,"0")}:{String(s).padStart(2,"0")}</div>;
    };

    const StartScreen = ({ onStart }) => (
      <div className="card center">
        <h2>Welcome to the English MockTest</h2>
        <p className="muted">B·∫°n s·∫Ω l√†m theo th·ª© t·ª±: <strong>Reading ‚Üí Writing ‚Üí Listening</strong>.</p>
        <button className="btn" onClick={onStart}>B·∫Øt ƒë·∫ßu l√†m b√†i ‚ñ∂</button>
      </div>
    );

    // ----- READING PRESENTER (Gi·ªØ nguy√™n t·ª´ b√†i tr∆∞·ªõc) -----
    function ReadingPresenter({ 
      passageTitle, passageText, questions, time, index, userAnswers, locked, 
      onSelect, onSubmit, onPrev, onNext 
    }) {
      const currentQuestion = questions[index]; // L·∫•y c√¢u h·ªèi hi·ªán t·∫°i
      
      return (
        <div className={`card ${locked?"locked-overlay":""}`}>
          <h2>Reading</h2>
          <Timer seconds={time}/>
          <div className="passage">
            <strong>{passageTitle}</strong>
            <p>{passageText}</p>
          </div>
          <h3>Question {index+1}</h3>
          <p>{currentQuestion.q}</p>
          <div className="choices">
            {currentQuestion.options.map(opt=>( 
              <button 
                key={opt} 
                onClick={() => onSelect(currentQuestion.id, opt)} // G·ª≠i ID v√† l·ª±a ch·ªçn
                className={userAnswers[currentQuestion.id] === opt ? "selected" : ""} 
                disabled={locked}
              >
                {opt}
              </button>
            ))}
          </div>
          <div className="nav">
            <button className="btn" onClick={onPrev} disabled={index === 0 || locked}>‚¨Ö Prev</button>
            <div style={{display:"flex", gap:10}}>
              <button className="btn" onClick={onSubmit} disabled={locked}>Submit Section</button>
              <button className="btn" onClick={onNext} disabled={index === questions.length - 1 || locked}>Next ‚û°</button>
            </div>
          </div>
        </div>
      );
    }

    // ----- READING CONTAINER (ƒê√É S·ª¨A) -----
    function ReadingSection({ onDone, initialTime }) {
      // **S·ª¨A 1: G·ªçi REPO ƒë·ªÉ l·∫•y data, kh√¥ng d√πng data global**
      const { passageTitle, passageText, questions } = mockTestRepo.getReadingDataForUI();
      
      const [time, setTime] = useState(initialTime);
      const [index, setIndex] = useState(0);
      // **S·ª¨A 2: ƒê·ªïi state `answers` t·ª´ Array sang Object ƒë·ªÉ l∆∞u theo ID**
      const [userAnswers, setUserAnswers] = useState({}); // v√≠ d·ª•: { "r1": "Emma Watson" }
      const [locked, setLocked] = useState(false);

      const handleSubmit = (isForced = false) => {
        if (locked) return;
        
        if (isForced || window.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp ph·∫ßn Reading n√†y kh√¥ng?")) {
          setLocked(true);
          
          // **S·ª¨A 3: G·ªçi SERVICE ƒë·ªÉ ch·∫•m ƒëi·ªÉm, kh√¥ng t·ª± t√≠nh**
          const { correctCount, total } = mockTestService.calculateReadingScore(userAnswers);
          
          // G·ª≠i k·∫øt qu·∫£ l√™n App
          onDone({
            section: "reading",
            locked: true,
            answers: userAnswers,
            correctCount: correctCount,
            total: total
          });
        }
      };

      useEffect(() => {
        if (locked) return;
        const timerId = setInterval(() => {
          setTime(prevTime => {
            if (prevTime <= 1) {
              clearInterval(timerId);
              handleSubmit(true); 
              return 0;
            }
            return prevTime - 1;
          });
        }, 1000);
        return () => clearInterval(timerId);
      }, [locked]);

      // **S·ª¨A 4: C·∫≠p nh·∫≠t state `answers` theo ID**
      const handleSelect = (questionId, option) => {
        if (locked) return;
        setUserAnswers(prevAnswers => ({
          ...prevAnswers, // Gi·ªØ c√°c c√¢u tr·∫£ l·ªùi c≈©
          [questionId]: option // C·∫≠p nh·∫≠t c√¢u tr·∫£ l·ªùi cho ID n√†y
        }));
      };

      const handlePrev = () => setIndex(i => Math.max(0, i - 1));
      const handleNext = () => setIndex(i => Math.min(questions.length - 1, i + 1));

      // Render Presenter (gi·ªëng b√†i tr∆∞·ªõc)
      return (
        <ReadingPresenter
          passageTitle={passageTitle}
          passageText={passageText}
          questions={questions}
          time={time}
          index={index}
          userAnswers={userAnswers}
          locked={locked}
          onSelect={handleSelect}
          onSubmit={() => handleSubmit(false)}
          onPrev={handlePrev}
          onNext={handleNext}
        />
      );
    }

    // =============== WRITING (ƒê√É S·ª¨A) ==================
    function WritingSection({ onDone, initialTime }) {
      // **S·ª¨A: G·ªçi REPO ƒë·ªÉ l·∫•y data**
      const w = mockTestRepo.getWritingData();
      
      const [text, setText] = useState("");
      const [time, setTime] = useState(initialTime);
      const [locked, setLocked] = useState(false);

      useEffect(() => {
        if (locked) return;
        const t = setInterval(() => setTime(p=>p<=1?(clearInterval(t),handleSubmit(true),0):p-1),1000);
        return ()=>clearInterval(t);
      }, [locked]);

      const handleSubmit = (isForced = false) => {
        if (locked) return; // NgƒÉn submit nhi·ªÅu l·∫ßn
        if (!isForced && !window.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp ph·∫ßn Writing n√†y kh√¥ng?")) return;
        setLocked(true);
        // Ph·∫ßn Writing kh√¥ng c·∫ßn Service, ch·ªâ c·∫ßn n·ªôp b√†i
        onDone({section:"writing",locked:true,text});
      };

      return (
        <div className={`card ${locked?"locked-overlay":""}`}>
          <h2>Writing</h2>
          <Timer seconds={time}/>
          <div className="passage">{w.prompt}</div>
          <p className="muted">{w.guidance}</p>
          <textarea value={text} onChange={e=>setText(e.target.value)} disabled={locked}/>
          <div className="nav">
            <div/>
            <button className="btn" onClick={() => handleSubmit(false)} disabled={locked}>Submit Section</button>
          </div>
        </div>
      );
    }

    // =============== LISTENING (ƒê√É S·ª¨A) ==================
    function ListeningSection({ onDone, initialTime }) {
      // **S·ª¨A 1: G·ªçi REPO ƒë·ªÉ l·∫•y data**
      const list = mockTestRepo.getListeningDataForUI();
      
      const [index, setIndex] = useState(0);
      // **S·ª¨A 2: ƒê·ªïi state `answers` sang Object**
      const [userAnswers, setUserAnswers] = useState({}); // v√≠ d·ª•: { "l1": "California" }
      const [time, setTime] = useState(initialTime);
      const [locked, setLocked] = useState(false);

      useEffect(()=>{
        if(locked) return;
        const t=setInterval(()=>setTime(p=>p<=1?(clearInterval(t),handleSubmit(true),0):p-1),1000);
        return()=>clearInterval(t);
      },[locked]);

      const handleSubmit = (isForced = false) => {
        if (locked) return;
        if (!isForced && !window.confirm("B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp ph·∫ßn Listening n√†y kh√¥ng?")) return;
        setLocked(true);
        
        // **S·ª¨A 3: G·ªçi SERVICE ƒë·ªÉ ch·∫•m ƒëi·ªÉm**
        const { correctCount, total } = mockTestService.calculateListeningScore(userAnswers);
        
        onDone({section:"listening",locked:true,answers: userAnswers, correctCount, total});
      };

      // **S·ª¨A 4: C·∫≠p nh·∫≠t state `answers` theo ID**
      const handleChange = (questionId, value) => {
        if (locked) return;
        setUserAnswers(prevAnswers => ({
          ...prevAnswers,
          [questionId]: value
        }));
      };
      
      const currentQuestion = list[index];

      return (
        <div className={`card ${locked?"locked-overlay":""}`}>
          <h2>üéß Listening: New Olympic Sports ‚Äì Wakeboarding & Roller Derby</h2>
          <audio controls style={{width:"100%",marginBottom:12}}>
            <source src="B2_sports_interviews.mp3" type="audio/mpeg"/>
            Your browser does not support the audio element.
          </audio>
          <Timer seconds={time}/>
          <h3>Question {index+1}</h3>
          <p>{currentQuestion.q}</p>

          {currentQuestion.options ? (
            <div className="choices">
              {currentQuestion.options.map(opt=>(
                <button 
                  key={opt} 
                  onClick={() => !locked && handleChange(currentQuestion.id, opt)} 
                  className={userAnswers[currentQuestion.id] === opt ? "selected" : ""} 
                  disabled={locked}
                >
                  {opt}
                </button>
              ))}
            </div>
          ) : (
            <input 
              value={userAnswers[currentQuestion.id] || ""} 
              onChange={e => handleChange(currentQuestion.id, e.target.value)} 
              disabled={locked} 
              style={{width:"100%",padding:10}}
            />
          )}

          <div className="nav">
            <button className="btn" onClick={()=>setIndex(i=>Math.max(0,i-1))} disabled={index===0||locked}>Prev</button>
            <div style={{display:"flex",gap:10}}>
              <button className="btn" onClick={() => handleSubmit(false)} disabled={locked}>Submit Section</button>
              <button className="btn" onClick={()=>setIndex(i=>Math.min(list.length-1,i+1))} disabled={index===list.length-1||locked}>Next</button>
            </div>
          </div>
        </div>
      );
    }

    // =============== MAIN APP (ƒê√É S·ª¨A) ==================
    function App() {
      // **S·ª¨A: G·ªçi REPO ƒë·ªÉ l·∫•y data**
      const times = mockTestRepo.getTimes();
      
      const [phase,setPhase]=useState("start");
      const [results,setResults]=useState({});

      const handleStart=()=>setPhase("reading");
      const handleSectionDone=d=>{
        setResults(p=>({...p,[d.section]:d}));
        if(d.section==="reading")setPhase("writing");
        else if(d.section==="writing")setPhase("listening");
        else if(d.section==="listening")setPhase("result");
      };

      if(phase==="start")return<StartScreen onStart={handleStart}/>;
      if(phase==="reading")return<ReadingSection onDone={handleSectionDone} initialTime={times.reading}/>;
      if(phase==="writing")return<WritingSection onDone={handleSectionDone} initialTime={times.writing}/>;
      if(phase==="listening")return<ListeningSection onDone={handleSectionDone} initialTime={times.listening}/>;
      
      if(phase==="result")return(
        <div className="card center">
          <h2>‚úÖ Test Completed</h2>
          <p>B·∫°n ƒë√£ ho√†n th√†nh to√†n b·ªô b√†i thi!</p>
          
          {/* **S·ª¨A: Hi·ªÉn th·ªã ƒëi·ªÉm s·ªë t·ª´ k·∫øt qu·∫£** */}
          <p><strong>Reading Score: {results.reading.correctCount} / {results.reading.total}</strong></p>
          <p><strong>Listening Score: {results.listening.correctCount} / {results.listening.total}</strong></p>
          
          <div style={{ marginTop: "20px", display: "flex", gap: "12px", justifyContent: "center" }}>
            <button className="btn" onClick={()=>setPhase("start")}>üîÅ L√†m l·∫°i b√†i</button>
            <a href="tu.html" className="btn" style={{ textDecoration: "none", lineHeight: "40px" }}>üè† Quay l·∫°i Trang ch·ªß</a>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>